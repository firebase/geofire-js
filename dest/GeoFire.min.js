var GeoFire=function(){"use strict";var e=function(e){return e*Math.PI/180},t=function(t,n){var i,r,o=t[0],a=t[1],c=n[0],s=n[1],u=6371,l=e(c-o),f=e(s-a);return i=Math.sin(l/2)*Math.sin(l/2)+Math.cos(e(o))*Math.cos(e(c))*Math.sin(f/2)*Math.sin(f/2),r=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),u*r},n=function(e,t){var n={min:-90,max:90},i={min:-180,max:180},r=e[0],o=e[1],a="",c=0,s=0,u=1;if(t=Math.min(t||12,22),r<n.min||r>n.max)throw"Invalid latitude specified! ("+r+")";if(o<i.min||o>i.max)throw"Invalid longitude specified! ("+o+")";for(;a.length<t;){var l=u?o:r,f=u?i:n,h=(f.min+f.max)/2;l>h?(c=(c<<1)+1,f.min=h):(c=(c<<1)+0,f.max=h),u=!u,4>s?s++:(s=0,a+="0123456789bcdefghjkmnpqrstuvwxyz"[c],c=0)}return a},i=function(e){return new RSVP.Promise(function(t,n){var i;"string"!=typeof e&&"number"!=typeof e&&(i="key must be a string or a number"),void 0!==i?n("Error: Invalid key '"+e+"': "+i):t()})},r=function(e){return new RSVP.Promise(function(t,n){var i;if(null===e&&t(),e instanceof Array&&2===e.length){var r=e[0],o=e[1];"number"!=typeof r||-90>r||r>90?i="latitude must be a number within the range [-90, 90]":("number"!=typeof o||-180>o||o>180)&&(i="longitude must be a number within the range [-180, 180]")}else i="expected 2 values, got "+e.length;void 0!==i?n("Erorr: Invalid location ["+e+"]: "+i):t()})},o=function(e,t,i){return new RSVP.Promise(function(r,o){null===i&&r(),e.child("indices/"+n(i,12)).set(t,function(e){e?o("Error: Firebase synchronization failed: "+e):r()})})},a=function(e,t,i,r){var o=function(){return new RSVP.Promise(function(i,o){void 0!==r[t]?e.child("indices/"+n(r[t].split(",").map(Number),12)).remove(function(e){e?o("Error: Firebase synchronization failed: "+e):i()}):i()}.bind(this))},a=function(){return new RSVP.Promise(function(n,r){e.child("locations/"+t).set(i?i.toString():null,function(e){e?r("Error: Firebase synchronization failed: "+e):n()})})};return o().then(function(){return a()})},c=function(e){if("function"!=typeof e)throw new Error("GeoCallbackRegistration.cancel() callback must be a function.");this._cancelCallback=e};c.prototype.cancel=function(){this._cancelCallback(),delete this._cancelCallback};var s=function(e,n){if("undefined"==typeof n.center)throw new Error('No "center" attribute specified for query criteria.');if("undefined"==typeof n.radius)throw new Error('No "radius" attribute specified for query criteria.');this._saveQueryCriteria(n),this._firebaseRef=e,this._callbacks={key_entered:[],key_left:[],key_moved:[]},this._locationsInQuery={},this._allLocations={},this._firebaseRef.child("indices").on("child_added",function(e){var t=e.val();this._firebaseRef.child("locations/"+t).once("value",function(e){var n=e.val().split(",").map(Number);this._allLocations[t]=n,this._fireCallbacks(t,n)}.bind(this))}.bind(this)),this._firebaseRef.child("locations").on("child_removed",function(e){var n=e.name();void 0!==this._locationsInQuery[n]&&(this._callbacks.key_left.forEach(function(e){e(n,this._allLocations[n],t(this._allLocations[n],this._center))}.bind(this)),delete this._allLocations[n])}.bind(this))};s.prototype._fireCallbacks=function(e,n){var i=void 0!==this._locationsInQuery[e],r=t(n,this._center),o=r<=this._radius;!i&&o?(this._callbacks.key_entered.forEach(function(t){t(e,n,r)}),this._locationsInQuery[e]=n):i&&!o?(this._callbacks.key_left.forEach(function(t){t(e,n,r)}),delete this._locationsInQuery[e]):i&&(this._callbacks.key_moved.forEach(function(t){t(e,n,r)}),this._locationsInQuery[e]=n)},s.prototype.getResults=function(){return new RSVP.Promise(function(e){var n=[];for(var i in this._locationsInQuery)this._locationsInQuery.hasOwnProperty(i)&&n.push({key:i,location:this._locationsInQuery[i],distance:t(this._locationsInQuery[i],this._center)});e(n)}.bind(this))},s.prototype.on=function(e,n){if(-1===["key_entered","key_left","key_moved"].indexOf(e))throw new Error('Event type must be "key_entered", "key_left", or "key_moved"');if("function"!=typeof n)throw new Error("Event callback must be a function.");if(this._callbacks[e].push(n),"key_entered"===e)for(var i in this._locationsInQuery)this._locationsInQuery.hasOwnProperty(i)&&n(i,this._locationsInQuery[i],t(this._locationsInQuery[i],this._center));return new c(function(){this._callbacks[e].splice(this._callbacks[e].indexOf(n),1)}.bind(this))},s.prototype.cancel=function(){this._callbacks={key_entered:[],key_left:[],key_moved:[]},this._firebaseRef.child("indices").off(),this._firebaseRef.child("locations").off()},s.prototype.updateQueryCriteria=function(e){this._saveQueryCriteria(e);for(var t in this._allLocations)this._allLocations.hasOwnProperty(t)&&this._fireCallbacks(t,this._allLocations[t])},s.prototype.getCenter=function(){return this._center},s.prototype.getRadius=function(){return this._radius},s.prototype._saveQueryCriteria=function(e){for(var t in e)if(e.hasOwnProperty(t)&&"center"!==t&&"radius"!==t)throw new Error('Unexpected "'+t+'" attribute found in query criteria.');if("undefined"!=typeof e.center){if(!(e.center instanceof Array&&2===e.center.length))throw new Error('Invalid "center" attribute specified for query criteria. Expected array of length 2, got '+e._center.length);var i=e.center[0],r=e.center[1];if("number"!=typeof i||-90>i||i>90)throw new Error('Invalid "center" attribute specified for query criteria. Latitude must be a number within the range [-90, 90]');if("number"!=typeof r||-180>r||r>180)throw new Error('Invalid "center" attribute specified for query criteria. Longitude must be a number within the range [-180, 180]')}if("undefined"!=typeof e.radius&&("number"!=typeof e.radius||e.radius<0))throw new Error('Invalid "radius" attribute specified for query criteria. Radius must be a number greater than or equal to 0.');this._center=e.center,this._centerHash=n(e.center,12),this._radius=e.radius};var u=function(e){var t=e,n={};t.child("locations").on("child_added",function(e){n[e.name()]=e.val()}),t.child("locations").on("child_removed",function(e){delete n[e.name()]}),this.set=function(e,c){return RSVP.all([i(e),r(c)]).then(function(){return a(t,e.toString(),c,n)}).then(function(){return o(t,e.toString(),c)})},this.get=function(e){return i(e).then(function(){return new RSVP.Promise(function(n,i){t.child("locations/"+e.toString()).once("value",function(e){n(e.val()?e.val().split(",").map(Number):null)},function(e){i("Error: Firebase synchronization failed: "+e)})})})},this.remove=function(e){return this.set(e,null)},this.query=function(e){return new s(t,e)}};return u}();"undefined"!=typeof module&&(module.exports=GeoFire);